name: Update Chart appVersions

on:
  schedule:
    - cron: "0 8 * * *" # Daily at 8:00 UTC
  workflow_dispatch: # Allow manual trigger

# Map each chart to its upstream GitHub repo.
# Add new entries here when you add a new chart.
env:
  CHART_MAP: |
    avalanche=ava-labs/avalanchego
    reth=paradigmxyz/reth

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for upstream updates
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$CHART_MAP" | while IFS='=' read -r chart upstream; do
            [ -z "$chart" ] && continue

            chart_yaml="charts/${chart}/Chart.yaml"
            if [ ! -f "$chart_yaml" ]; then
              echo "::warning::Chart file not found: $chart_yaml"
              continue
            fi

            current=$(grep '^appVersion:' "$chart_yaml" | sed 's/appVersion: *"\?\([^"]*\)"\?/\1/')
            latest=$(gh api "repos/${upstream}/releases/latest" --jq '.tag_name' 2>/dev/null || echo "")

            if [ -z "$latest" ]; then
              echo "::warning::Could not fetch latest release for ${upstream}"
              continue
            fi

            echo "${chart}: current=${current} latest=${latest}"

            if [ "$current" = "$latest" ]; then
              echo "  -> up to date"
              continue
            fi

            echo "  -> update available!"

            branch="auto-update/${chart}-${latest}"

            # Check if a PR already exists for this version
            existing=$(gh pr list --head "$branch" --json number --jq 'length')
            if [ "$existing" != "0" ]; then
              echo "  -> PR already exists, skipping"
              continue
            fi

            # Bump appVersion
            sed -i "s/^appVersion: .*/appVersion: \"${latest}\"/" "$chart_yaml"

            # Bump chart patch version
            chart_version=$(grep '^version:' "$chart_yaml" | awk '{print $2}')
            major=$(echo "$chart_version" | cut -d. -f1)
            minor=$(echo "$chart_version" | cut -d. -f2)
            patch=$(echo "$chart_version" | cut -d. -f3)
            new_version="${major}.${minor}.$((patch + 1))"
            sed -i "s/^version: .*/version: ${new_version}/" "$chart_yaml"

            # Create branch and PR
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git checkout -b "$branch"
            git add "$chart_yaml"
            git commit -m "chore(${chart}): bump appVersion to ${latest}"
            git push origin "$branch"

            pr_body="Upstream [${upstream}](https://github.com/${upstream}) released **${latest}** (current: ${current}).

          ## Changes
          - \`appVersion\`: ${current} -> ${latest}
          - \`version\`: ${chart_version} -> ${new_version}

          Auto-generated by the update-appversions workflow."

            gh pr create \
              --title "chore(${chart}): bump appVersion to ${latest}" \
              --body "$pr_body" \
              --head "$branch" \
              --base main

            # Return to main for the next chart
            git checkout main
            git checkout -- .
          done
